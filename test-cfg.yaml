#-------------------------------------------------------------------------------
#
# SDK Jenkins Pipeline Configuration
#
# Copyright (C) 2022, HENSOLDT Cyber GmbH
#
#-------------------------------------------------------------------------------

# Format for test configurations:
#
# <system name>
#   flags: [SDK_DEMO]
#   testSystem: <repo>
#   testScript: <name, defaults to <system name>.py >
#   buildParams:
#   - -D TEST_CONFIGURATION=<target>
#   testParams:
#   - --tc=platform.test_configuration:<target>"
#   platforms: # can be a simple array or a map
#     <name1>:
#     <name2>:
#       addFlags: [SDK_DEMO]
#       buildParams: <array>
#       testParams: <array>


#-------------------------------------------------------------------------------
# Fundamental Demo Systems, required for the SDK package sanity check
#-------------------------------------------------------------------------------

demo_hello_world:
  flags: [SDK_DEMO]
  testScript: test_demo_hello_world.py
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]
    qemu-arm-virt-a15:
    qemu-arm-virt-a53:
    qemu-riscv-virt32:
    qemu-riscv-virt64:
    spike64:
    spike32: # ToDo: starting still fails
    rpi3:
    rpi4:
    nitrogen6sx:


#-------------------------------------------------------------------------------
# Additional Official Demo System
#-------------------------------------------------------------------------------

demo_vm_minimal:
  testScript: test_demo_vm_minimal.py
  platforms:
    qemu-arm-virt-a15:
    qemu-arm-virt-a53:
    qemu-riscv-virt32:
    qemu-riscv-virt64:


# This needs a TimeServer, which QEMU currently does not provide
#demo_vm_serialserver:
#  testScript: test_demo_vm_serialserver.py
#  platforms:
#    qemu-arm-virt-a53:

demo_vm_virtio_net:
  testScript: test_demo_vm_virtio_net.py
  platforms:
    qemu-arm-virt-a53:

demo_iot_app:
  flags: [SDK_DEMO]
  testScript: test_demo_iot_app.py
  platforms:
    zynq7000:
      addFlags: [QEMU]
    zynqmp: # ToDO: Clarify why test fails
      addFlags: [QEMU]

demo_iot_app_imx6:
  flags: [SDK_DEMO]
  testScript: test_demo_iot_app.py
  platforms:
    sabre: # ToDO: fix test failures
      addFlags: [QEMU]
    nitrogen6sx:

# This RasPi3 IoT Demo is broken because the component RPi_SPI_Flash conflicts
# with latest seL4 libplatsupport changes
#
#   demo_iot_app_rpi3:
#     flags: [SDK_DEMO]
#     platforms: [rpi3]

demo_tls_api:
  flags: [SDK_DEMO]
  testScript: test_demo_tls_api.py
  platforms:
    zynq7000:
      addFlags: [QEMU]
    sabre:
      addFlags: [QEMU]
    nitrogen6sx:
    rpi3:

# Currently there is no test.
demo_network_filter:
  flags: [SDK_DEMO]
  platforms:
    zynq7000:
      addFlags: [QEMU]
    nitrogen6sx:

#-------------------------------------------------------------------------------
# Unofficial Demo Systems
#-------------------------------------------------------------------------------

# This needs to run on real hardware. Currently there is no test.
demo_i2c:
  platforms: [sabre]

# This needs to run on real hardware. Currently there is no test.
demo_tls_server:
  platforms: [zynq7000]

# This test was used during porting the RPi Ethernet driver only. The RasPi3
# Socket API of this test needs to be adapted to the recent changes. But this
# test system is to be deleted anyway, once it's confirmed that all relevant
# parts were integrated into test_network_api.
#
#   demo_raspi_ethernet:
#     platforms: [rpi3]

#------------------------------------------------------------------------------
# Test Systems
#
# Testing ZynqMP requires using the test container trentos_test:20210316
# which contains the Xilinx QEMU.
#------------------------------------------------------------------------------

test_timeserver:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp: # ToDO: fix failing test
      addFlags: [QEMU]
    spike64:
    rpi3:
    rpi4:

test_certserver:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]
    spike64:
    rpi3:

test_uart:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]

test_chanmux:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]
    # spike64 has not additional UART

test_proxy_nvm:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]
    # spike64 has not additional UART

test_certparser:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]
    spike64:

test_crypto_api:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]
    spike64:

test_cryptoserver:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]
    spike64:

test_entropysource:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]
    spike64:

test_storage_interface:
  testScript: test_storage_interface*.py
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp: # ToDo: fix broken test
      addFlags: [QEMU]
    spike64:
    rpi3:
    rpi4:

test_filesystem:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]
    spike64:

test_config_server:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]
    spike64:

test_keystore:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]
    spike64:

test_logserver:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    zynqmp:
      addFlags: [QEMU]
    spike64:

test_tls_api:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    # no network support: zynqmp/QEMU, spike64
    nitrogen6sx:
    rpi3:

test_tlsserver:
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    # no network support: zynqmp/QEMU, spike64
    nitrogen6sx:
    rpi3:

test_network_api_tcp_client_single_socket:
  testScript: test_network_api.py
  testSystem: ss/test_network_api
  buildParams: -D TEST_CONFIGURATION=tcp_client_single_socket
  testParams: --tc=platform.test_configuration:tcp_client_single_socket
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    # no network support: zynqmp/QEMU, spike64

test_network_api_tcp_client_multiple_sockets:
  testScript: test_network_api.py
  testSystem: ss/test_network_api
  buildParams: -D TEST_CONFIGURATION=tcp_client_multiple_sockets
  testParams: --tc=platform.test_configuration:tcp_client_multiple_sockets
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    # no network support: zynqmp/QEMU, spike64

test_network_api_tcp_client_multiple_clients:
  testScript: test_network_api.py
  testSystem: ss/test_network_api
  buildParams: -D TEST_CONFIGURATION=tcp_client_multiple_clients
  testParams: --tc=platform.test_configuration:tcp_client_multiple_clients
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    # no network support: zynqmp/QEMU, spike64

test_network_api_tcp_server:
  testScript: test_network_api.py
  testSystem: ss/test_network_api
  buildParams: -D TEST_CONFIGURATION=tcp_server
  testParams: --tc=platform.test_configuration:tcp_server
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    # no network support: zynqmp/QEMU, spike64
    nitrogen6sx:
    rpi3:

test_network_api_udp_server:
  testScript: test_network_api.py
  testSystem: ss/test_network_api
  buildParams: -D TEST_CONFIGURATION=udp_server
  testParams: --tc=platform.test_configuration:udp_server
  platforms:
    sabre:
      addFlags: [QEMU]
    zynq7000:
      addFlags: [QEMU]
    # no network support: zynqmp/QEMU, spike64
